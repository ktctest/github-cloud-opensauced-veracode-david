image: docker.ktc.local/runner/maven-runner:3.9.2-JDK17

variables:
  KTC_CERTIFICATE_URL: "https://sedeka2.ktc.local/ucs-root-ca.crt"
  APP_NAME: "EcommerceApp-master"
  MAVEN_OPTS: "-Dmaven.repo.local=.$CI_PROJECT_DIR/m2/repository"

stages:
  - build
  - test
  - code_analysis
  - application_analysis

cache:
  paths:
    - .m2/repository/
    - target/

Build:
  stage: build
  script:
    - mvn $MAVEN_CLI_OPTS package -DskipTests
    - pwd
    - ls -la
  artifacts:
    name: ${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHA}_build
    paths:
      - builds/

Unit Test:
  stage: test
  script:
    - mvn $MAVEN_CLI_OPTS test
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml

Veracode-SCA:
  stage: code_analysis
  script:
    - curl -sSL https://download.sourceclear.com/ci.sh | sh

Veracode-SAST:
  stage: application_analysis
  artifacts:
    name: ${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHA}_pipeline-results
    paths:
      - results.json
      - veracode_gitlab_vulnerabilities.json
    reports:
      sast: veracode_gitlab_vulnerabilities.json
    expire_in: 1 week
    when: always
  before_script:
    - apt-get update -qy
    - apt-get install -y zip unzip
  script:
    - curl -O https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip
    - unzip pipeline-scan-LATEST.zip pipeline-scan.jar
    - java -jar pipeline-scan.jar
      --issue_details "true"
      --summary_display "true"
      --policy_name "Veracode Recommended Medium + SCA"
      --veracode_api_id "$VERACODE_API_KEY_ID"
      --veracode_api_key "$VERACODE_API_KEY_SECRET"
      --timeout "${CI_TIMEOUT}"
      --file "./target/EcommerceApp.war"
      --app_id "$VERACODE_APP_ID"
      --project_name "${CI_PROJECT_PATH}"
      --project_url "${CI_REPOSITORY_URL}"
      --project_ref "${CI_COMMIT_REF_NAME}"
      --gl_issue_generation "true"
      --gl_vulnerability_generation "true"
